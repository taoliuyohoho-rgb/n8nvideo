# Cursor 用户规则（User Rules）

面向本项目在 Cursor 中的日常开发协作规范。遵循 PRD 与技术方案推进，前后端分离，组件解耦，开发后自测保证可运行。

## 1. 需求与任务拆解
- 以 PRD 为准：严格对齐 `docs/PRD.md` 与已讨论的产品目标、验收标准、边界条件。
- 技术方案先行：实现前快速评审技术方案（接口、数据模型、依赖、风险）。若有变更，更新相应设计文档。
- 小步快跑：任务细化为可在 0.5–1 天内完成的子项；每项产出可运行、可验证的增量。

## 2. 前后端分离与解耦
- API 合同先定义：在 `app/api/**` 或 `src/**` 中明确请求/响应 Schema；后端自包含校验与错误码。
- 组件解耦：前端组件尽量无副作用；将数据获取、状态管理与展示解耦；避免跨层直接耦合。
- 禁用跨模块隐式依赖：通过明确导出与公共类型共享，禁止从非公开路径 import 内部实现。

## 3. 开发流程（逐步推进）
1) 明确需求→产出任务清单与验收标准。
2) 定义/更新 API 合同、类型与数据模型。
3) 后端接口实现与自测（含错误路径与边界）。
4) 前端对接 Mock 或真实接口，自测 UI/交互/异常。
5) 端到端联调，自测通过再提交。

## 4. 自测要求（每次提交前）
- 运行开发服务器，关键流程“可走通、无报错、输出正确”。
- 覆盖正常流/异常流：空输入、越界、无权限、外部服务失败。
- AI 相关流程：
  - 使用 `verified-models.json` 已验证的 Key；
  - 若 vision/搜索能力缺失，应有可见的降级与提示；
  - 使用 `callWithSchema` 校验 JSON 输出，失败自动修复；
  - 幂等 `idempotencyKey` 场景测试。

## 5. 提交规范
- 原子提交：一个提交完成一个小任务，附带清晰信息（变更内容+动机）。
- 不引入 ESLint/TS 错误；不提交临时调试代码/机密信息。
- 变更 API/类型/数据模型需同步更新文档与样例。

## 6. 代码约定（结合本仓库）
- 在编辑前，定位相关文件与导出类型；必要时先补充类型。
- 写代码遵循本仓库 TypeScript 风格与现有目录组织。
- 仅对相关文件做“最小必要编辑”，不大范围重排格式。
- 重要逻辑加入简洁、价值高的注释（非显而易见的约束/边界/安全隐患）。

## 7. 验收与回归
- 自测通过后，按验收标准逐条复核。
- 若引入新配置项（env/ai-config），需提供默认值与回滚策略。
- 关键路径（AI 路由、视频生成、数据库写入）做一次回归走查。

---

附：常见自查清单
- API：请求校验、鉴权、错误码、幂等、速率限制、降级
- 前端：加载/错误状态、输入校验、空态、可访问性、移动端
- 数据：索引/唯一约束、迁移脚本、种子数据、兼容老数据
- AI：模型选择、JSON 严格模式、证据约束、fallback、超时重试
