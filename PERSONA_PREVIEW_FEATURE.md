# 人设生成预览与编辑功能

## 🎯 新功能概述

### 问题修复
1. ✅ 修复推荐 API 500 错误
2. ✅ 简化推荐逻辑，不依赖复杂的推荐引擎
3. ✅ 添加人设预览功能
4. ✅ 支持编辑AI生成的内容
5. ✅ 确认后再保存到数据库

### 核心流程

```
1. 填写基本信息
   ↓
2. 点击"生成预览"
   ↓
3. AI 推荐模型和 Prompt
   ↓
4. AI 生成人设内容
   ↓
5. 显示预览（Tab式界面，可编辑）
   ↓
6. 用户编辑调整
   ↓
7. 点击"保存到库"
   ↓
8. 保存到数据库
```

## 📋 详细说明

### 1. 推荐 API 优化

**文件：** `app/api/persona/recommend/route.ts`

**变更：**
- ✅ 移除对复杂推荐引擎的依赖
- ✅ 使用简化的推荐逻辑
- ✅ 自动创建默认 Prompt 模板（如果不存在）
- ✅ 默认推荐 Gemini 2.0 Flash 模型

**推荐逻辑：**
```typescript
// 简单且可靠的推荐
const recommendedModel = {
  id: 'gemini-2.0-flash-exp',
  name: 'Gemini 2.0 Flash',
  provider: 'Google',
  reason: `适合${category.name}类目的人设生成，速度快且质量高`
}

// 从数据库查找或创建默认 Prompt
let promptTemplate = await prisma.promptTemplate.findFirst({
  where: {
    businessModule: 'persona-generation',
    isActive: true
  }
})

if (!promptTemplate) {
  // 自动创建默认模板
  promptTemplate = await prisma.promptTemplate.create({...})
}
```

**默认 Prompt 模板：**
- 包含完整的人设结构
- 要求真实可信的内容
- 强调不使用占位符
- 确保返回有效 JSON

### 2. 新版人设表单弹窗

**文件：** `app/admin/components/PersonaFormModalV2.tsx`

**两步流程：**

#### 步骤 1：表单填写

```
┌─────────────────── 创建人设 ───────────────────┐
│                                                 │
│ 人设名称 *      [____________]  目标市场 *     │
│                                  [马来西亚 ▼]   │
│                                                 │
│ 人设描述        [_________________________]    │
│                                                 │
│ 类目 *          [3C数码 ▼]      关联商品      │
│                                  [选择... ▼]    │
│                                                 │
│ 人设描述（帮助AI生成）                          │
│ ┌───────────────────────────────────────────┐ │
│ │ 25-35岁的年轻专业人士...                  │ │
│ └───────────────────────────────────────────┘ │
│                                                 │
│                    [取消]  [生成预览 👁]       │
└─────────────────────────────────────────────────┘
```

#### 步骤 2：预览编辑

```
┌─────────────── 创建人设 - 预览与编辑 ───────────┐
│                                                 │
│ ┌ 基础信息 ┬ 行为特征 ┬ 偏好特征 ┬ 心理特征 ┐   │
│ │                                           │   │
│ │ 年龄段  [25-35        ]  性别 [男性为主  ] │   │
│ │ 职业    [IT专业人士   ]  收入 [中高收入  ] │   │
│ │ 地区    [吉隆坡、槟城等大城市           ] │   │
│ │                                           │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│          [← 返回修改]  [保存到库 💾]            │
└─────────────────────────────────────────────────┘
```

**Tab 分类：**
1. **基础信息** - 年龄、性别、职业、收入、地区
2. **行为特征** - 购买习惯、使用场景、决策因素、品牌偏好
3. **偏好特征** - 价格敏感度、功能需求、品质期望、服务期望
4. **心理特征** - 价值观、生活方式、痛点、动机

**编辑功能：**
- ✅ 所有字段都可以编辑
- ✅ 数组字段用逗号分隔输入
- ✅ 实时保存更改到状态
- ✅ 可以返回表单重新生成

### 3. 使用流程

#### 创建新人设

1. **打开弹窗**
   - 点击"添加人设"

2. **填写信息**
   ```
   人设名称: 泰国年轻创业者
   目标市场: 泰国
   类目: 3C数码
   人设描述: 
     25-30岁，喜欢尝试新科技，
     经常在社交媒体分享产品体验
   ```

3. **生成预览**
   - 点击"生成预览"
   - 等待 AI 生成（3-10秒）

4. **查看和编辑**
   - 在 Tab 中查看生成的内容
   - 点击字段进行编辑
   - 例如：修改年龄段从"25-30"到"25-35"

5. **保存**
   - 确认无误后点击"保存到库"
   - 自动返回列表

#### 编辑已有人设

1. **打开编辑**
   - 点击人设的编辑按钮
   - 直接进入预览页面（显示现有数据）

2. **编辑内容**
   - 在 Tab 中修改任意字段
   - 可以返回表单修改基本信息

3. **保存更改**
   - 点击"保存到库"
   - 更新数据库

### 4. 技术实现

#### 状态管理

```typescript
const [step, setStep] = useState<'form' | 'preview'>('form')
const [personaContent, setPersonaContent] = useState<PersonaContent | null>(null)
```

#### 内容更新

```typescript
const updatePersonaContent = (path: string[], value: any) => {
  const updated = { ...personaContent }
  let current: any = updated
  
  // 深度更新
  for (let i = 0; i < path.length - 1; i++) {
    current = current[path[i]]
  }
  current[path[path.length - 1]] = value
  
  setPersonaContent(updated)
}

// 使用
updatePersonaContent(['basicInfo', 'age'], '25-35')
updatePersonaContent(['psychology', 'values'], ['创新', '效率'])
```

#### 数组处理

```typescript
// 显示：数组转字符串
value={personaContent.psychology.values.join(', ')}

// 编辑：字符串转数组
onChange={(e) => updatePersonaContent(
  ['psychology', 'values'], 
  e.target.value.split(',').map(s => s.trim())
)}
```

### 5. API 流程

```
Client                    API                     Database
  │                        │                         │
  ├─1. POST /recommend────→│                         │
  │  {categoryId, ...}     │                         │
  │                        ├─查询类目───────────────→│
  │                        ├─查找 Prompt 模板───────→│
  │←──返回推荐────────────┤                         │
  │                        │                         │
  ├─2. POST /generate─────→│                         │
  │  {categoryId,          │                         │
  │   aiModel, prompt}     │                         │
  │                        ├─调用 AI API             │
  │←──返回生成内容────────┤                         │
  │                        │                         │
  │  [用户编辑]            │                         │
  │                        │                         │
  ├─3. POST /save─────────→│                         │
  │  {name, content}       │                         │
  │                        ├─保存人设───────────────→│
  │←──保存成功────────────┤                         │
  │                        │                         │
```

## 🎨 界面展示

### Tab 式预览界面

**基础信息 Tab：**
```
┌─ 基础信息 ────────────────────────────────────┐
│                                                │
│ 年龄段    [25-35              ]                │
│ 性别      [男性为主            ]                │
│ 职业      [IT专业人士、创业者  ]                │
│ 收入水平  [中高收入（RM 5000-10000）]          │
│ 地区      [吉隆坡、槟城等大城市]                │
│                                                │
└────────────────────────────────────────────────┘
```

**行为特征 Tab：**
```
┌─ 行为特征 ────────────────────────────────────┐
│                                                │
│ 购买习惯                                       │
│ ┌────────────────────────────────────────┐   │
│ │喜欢在线购物，关注产品评测和开箱视频，│   │
│ │追求性价比和最新技术                  │   │
│ └────────────────────────────────────────┘   │
│                                                │
│ 使用场景                                       │
│ ┌────────────────────────────────────────┐   │
│ │工作、娱乐、社交分享                  │   │
│ └────────────────────────────────────────┘   │
│                                                │
└────────────────────────────────────────────────┘
```

## 📊 优势

### 用户体验
- ✅ **所见即所得** - 生成前预览，避免不满意
- ✅ **灵活编辑** - 可以微调 AI 生成的内容
- ✅ **分类清晰** - Tab 式界面，信息组织合理
- ✅ **快速迭代** - 可以返回重新生成

### 数据质量
- ✅ **人工审核** - 保存前可以检查所有字段
- ✅ **精确控制** - 不满意的地方手动修改
- ✅ **减少错误** - 避免 AI 生成的不准确内容直接入库

### 开发维护
- ✅ **简化推荐** - 不依赖复杂的推荐引擎
- ✅ **降低故障** - 减少外部依赖
- ✅ **易于调试** - 流程清晰，问题容易定位

## 🧪 测试清单

### 推荐 API
- [ ] 访问 `/api/persona/recommend` 返回 200
- [ ] 返回数据包含 `recommendedModel` 和 `recommendedPrompt`
- [ ] Prompt 模板自动创建（首次）
- [ ] 后续访问使用已有模板

### 表单页面
- [ ] 填写所有必填字段
- [ ] 点击"生成预览"无报错
- [ ] 显示加载状态

### 预览页面
- [ ] 4个 Tab 都可以切换
- [ ] 所有字段都显示 AI 生成的内容
- [ ] 可以编辑任意字段
- [ ] 数组字段正确显示和编辑

### 保存功能
- [ ] 点击"保存到库"成功
- [ ] 数据库正确保存
- [ ] 列表显示新人设
- [ ] 编辑后保存更新正确

### 编辑模式
- [ ] 打开编辑直接显示预览
- [ ] 预填充现有数据
- [ ] 可以修改并保存
- [ ] 可以返回表单重新生成

## ⚠️ 注意事项

### 1. AI 生成时间
- 通常需要 3-10 秒
- 显示加载状态
- 超时后显示错误

### 2. 数据验证
- 保存前检查必填字段
- 数组字段至少有一个元素
- JSON 格式验证

### 3. 错误处理
- API 错误显示友好提示
- AI 生成失败可以重试
- 网络问题提示用户

## 🚀 快速测试

```bash
# 1. 启动服务
npm run dev

# 2. 访问 Admin
http://localhost:3000/admin

# 3. 点击人设管理
# 4. 点击"添加人设"
# 5. 填写表单
# 6. 点击"生成预览"
# 7. 编辑内容
# 8. 点击"保存到库"
```

---

**更新时间**: 2025-10-29  
**状态**: ✅ 已完成  
**版本**: v3.0 - 预览与编辑

